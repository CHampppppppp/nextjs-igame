# iGame Lab AI Agent 设置指南

## 概述

iGame Lab AI Agent 是一个基于 RAG（Retrieval-Augmented Generation）技术的智能聊天助手，为实验室网站提供智能问答服务。

## 核心功能

- **智能问答**：基于实验室知识库回答相关问题
- **RAG 长时记忆**：支持文档上传和知识库管理
- **实时对话**：流畅的聊天界面和打字效果
- **记忆管理**：隐藏的管理页面用于文档管理

## 技术架构

```
用户输入 → DeepSeek API → RAG 检索 → 上下文增强 → 智能回复
                            ↑
                    ChromaDB 向量数据库
                            ↑
                    记忆文档 → 向量化处理
```

## 安装和设置

### 1. 环境变量配置

创建 `.env.local` 文件并配置以下变量：

```bash
# AI配置
DEEPSEEK_API_KEY=your_deepseek_api_key_here

# OpenAI API配置 (支持第三方平台如uiuiapi)
OPENAI_API_KEY=your_openai_api_key_from_uiuiapi
OPENAI_API_BASE_URL=https://api.uiuiapi.com/v1

# 数据库配置
CHROMA_DB_PATH=./data/chroma
```

**重要说明**: 本项目支持使用第三方 OpenAI API 提供商，如 [uiuiapi](https://uiuiapi.com)。如果您使用 uiuiapi 或其他第三方平台，请参考 `UIUIAPI_CONFIG.md` 获取详细配置说明。

### 2. 测试 API 配置

首先测试您的 uiuiapi 配置是否正确：

```bash
cd my-app
npx tsx scripts/test-uiuiapi.ts
```

如果测试成功，会显示向量嵌入的维度信息。

### 3. 初始化记忆库

运行初始化脚本创建基础知识库：

```bash
npx tsx scripts/init-memories.ts
```

### 3. 启动服务

```bash
npm run dev
```

## 使用说明

### AI 聊天助手功能

#### 智能意图判断与问答
1. **意图识别**：使用 DeepSeek AI 判断用户问题是否与实验室相关
2. **智能路由**：
   - 实验室相关问题 → 使用 RAG 检索实验室知识库回答
   - 通用问题 → 直接用大模型回答
3. **时间查询**：自动识别时间相关问题并提供当前时间
4. **容错机制**：当 DeepSeek API 不可用时，自动切换到关键词匹配后备方案

#### 使用方法
1. 在网站右下角点击聊天按钮
2. 输入您的问题
3. AI助手会智能判断问题类型并给出相应回答

#### 意图判断示例

**实验室相关问题**（使用 RAG）：
- "你们实验室有多少人？"
- "徐岗教授是做什么的？"
- "实验室主要研究什么方向？"
- "杭州电子科技大学iGame实验室的情况"

**通用问题**（直接回答）：
- "今天天气怎么样？"
- "1+1等于几？"
- "计算机视觉有哪些应用？"

**时间查询**（特殊处理）：
- "现在几点了？"
- "当前时间是什么？"

#### 离线模式支持

当 AI 服务暂时不可用时，系统会自动切换到离线模式，提供预设的回答：

**实验室相关问题离线回答**：
- 实验室规模：6名教师，40多名研究生，3名博士研究生
- 负责人信息：徐岗教授
- 研究方向：计算机辅助设计与仿真、等几何分析、计算机视觉、机器学习
- 学校信息：杭州电子科技大学计算机学院

**通用问题离线回答**：
- 简单问候和对话
- 基础数学问题
- 常见问题解答

**时间查询离线回答**：
- 提供本地系统时间

### 管理记忆文档

访问隐藏管理页面：`http://localhost:3000/admin/memories`

功能包括：
- 上传新文档（支持 .txt、.pdf、.md 格式）
- 查看现有文档列表
- 删除不需要的文档

## API 接口

### 聊天接口

```
POST /api/chat
```

请求体：
```json
{
  "message": "用户消息",
  "sessionId": "可选的会话ID"
}
```

### 记忆文档管理

```
GET /api/memories          # 获取所有文档
DELETE /api/memories       # 删除指定文档

POST /api/memories/upload  # 上传新文档
```

## 文档格式支持

- **文本文件** (.txt)：直接读取内容
- **Markdown文件** (.md)：支持Markdown格式
- **PDF文件** (.pdf)：自动提取文本内容

## 最佳实践

### 文档管理

1. **文档命名**：使用描述性的标题
2. **内容组织**：将相关信息组织在同一文档中
3. **定期更新**：及时更新过时的信息
4. **质量控制**：确保文档内容准确可靠

### 问题优化

1. **具体问题**：提出具体的技术或研究问题
2. **上下文信息**：提供相关背景信息
3. **分步询问**：复杂问题可以分步骤询问

## 故障排除

### 常见问题

1. **聊天无响应**
   - 检查 API 密钥是否正确配置
   - 确认网络连接正常

2. **文档上传失败**
   - 检查文件格式是否支持
   - 确认文件大小不超过限制

3. **向量搜索无结果**
   - 确保已初始化基础记忆文档
   - 检查文档内容质量

### 日志查看

系统会在控制台输出详细的调试信息，帮助定位问题。

## 扩展开发

### 添加新功能

1. **自定义提示词**：修改 `lib/ai/chat.ts` 中的系统提示
2. **新的文档类型**：扩展 `api/memories/upload/route.ts` 支持更多格式
3. **高级检索**：实现基于元数据的过滤搜索

### 性能优化

1. **缓存策略**：添加 Redis 缓存层
2. **批量处理**：优化大文档的处理效率
3. **并发控制**：限制同时处理的请求数量

## 安全注意事项

1. **API密钥保护**：确保环境变量不被泄露
2. **访问控制**：管理页面需要适当的访问限制
3. **内容审核**：对上传文档进行安全检查
4. **数据备份**：定期备份向量数据库

## 技术支持

如遇到技术问题，请查看：
- 控制台错误日志
- API 响应状态
- 向量数据库连接状态

---

*最后更新：2025年12月29日*
